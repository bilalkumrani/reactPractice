require('array-sugar');
var agent = require('superagent');
var semver = require('semver');
var fs = require('fs');
var _ = require('lodash');

var nlv = module.exports = (function() {
  Resolver.timeout = (process.env.NODE_ENV === 'test' ? 1 : process.env.RESOLVER_TIMEOUT || 5000);

  function Resolver(cb) {
    this.downloadVersions((function(_this) {
      return function(err, text) {
        if (err) {
          throw err;
        }
        _this.all = _.uniq(text.match(/[0-9]+\.[0-9]+\.[0-9]+/g).filter(function(version) {
          return semver.gte(version, "0.8.6");
        }).sort(function(a, b) {
          return semver.compare(a, b);
        }));
        _this.stables = _.uniq(text.match(/[0-9]+\.[0-9]*[02468]\.[0-9]+/g).filter(function(version) {
          return semver.gte(version, "0.8.6");
        }).sort(function(a, b) {
          return semver.compare(a, b);
        }));
        if (process.env.STABLE_NODE_VERSION) {
          _this.stables = _this.stables.filter(function(version) {
            return semver.lte(version, process.env.STABLE_NODE_VERSION);
          });
        }
        _this.latest_unstable = _this.all.last;
        _this.latest_stable = _this.stables.last;
        if (cb) {
          return cb(_this);
        }
      };
    })(this));
  }

  Resolver.prototype.downloadVersions = function(cb) {
    return agent.get("http://nodejs.org/dist/").timeout(Resolver.timeout).end(function(err, res) {
      if (err) {
        return cb(null, fs.readFileSync(__dirname + '/cache/node.html').toString());
      }
      return cb(null, res.text);
    });
  };

  Resolver.prototype.satisfy = function(range) {
    if (!semver.validRange(range)) {
      return this.latest_stable;
    }
    return semver.maxSatisfying(this.stables, range) || semver.maxSatisfying(this.all, range) || this.latest_stable;
  };

  return Resolver;

})();

module.exports.satisfy = {
  sync: function (range) {
    var maxSatisfying = semver.maxSatisfying(require('./versions').tags, range);

    return maxSatisfying || 'stable';
  }
};
